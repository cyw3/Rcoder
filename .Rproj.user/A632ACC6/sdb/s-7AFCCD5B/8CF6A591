{
    "contents" : "\n\nlibrary(qutke)\n\n#1、设定参数（包括股票组）\n#股票组20，取最高的5支，时间是2015-01-01至今\n\n#试验qtid\nqtid <- '002230.SZ'\n\n\nsDate<-as.Date(\"2014-1-1\") #开始日期\neDate<-Sys.Date() #结束日期\n#2、取每支股票的每交易日收盘价\n#3、数据处理，移动均值ma\n\n#已有MACD\ndailyQuote <- getDailyQuote(data='mktFwdDaily',qtid=qtid,startdate=sDate,enddate=eDate,key=key)\nldata <- dailyQuote[,grep(\"date|close|ma5|ma20\", names(dailyQuote)) ]\n#为true时候，补全ldata中是na的数值，以最近日期的数据 进行赋值 \n#names(ldata)<-c('Value',paste('ma',mas,sep=''))\nldata<-na.locf(ldata, fromLast=TRUE)\n\n\n#4、标定UP、Down\n# 散点数据\n# 计算pdata,\ngenPoint<-function(args=c(),ldata){\n  if(length(args)>2){\n    stop('The length of args is two.')\n  }\n  if(length(args)<2){\n    args <- c(args,2)\n  }\n  \n  pdata <- data.frame()\n  \n  #pdata <- ldata[which(ldata$Value>ldata$ma20)]$ma20\n  pdata <- ldata[which(ldata[,args[2]]>ldata[,args[1]]),][,c(1,args[1])]\n  names(pdata)<-'Down'\n  pdata <- fortify(pdata,melt=TRUE)\n  \n  xdata <- ldata[which(ldata[,args[2]]<ldata[,args[1]])][,c(1,args[1])]\n  names(xdata) <- 'UP'\n  xdata <- fortify(xdata,melt=TRUE)\n  \n  pdata <- rbind(pdata,xdata)\n  return(pdata)\n  \n} #代码省略\n\npdata<-genPoint(c(4,3),ldata)\n\n\n#5、取交易点\n#交易信号 cdata:索引+收盘价\n#dataFrame按列排序\n#pdata[order(pdata[,1],decreasing=F),]\n\n#1为B  2为S\nSignal<-function(cdata,pdata){\n  \n  pdata <- pdata[order(pdata[,1],decreasing=F),]\n  #op <- factor(c('B','S','N'))\n  \n  op <- pdata[1,]\n  tmp <- op$Series\n  i <- 2\n  nrow <- nrow(pdata)\n  while(i<=nrow){\n    if(tmp!=pdata[i,]$Series){\n      op <- rbind(op,pdata[i,])\n    }\n    tmp <- pdata[i,]$Series\n    i=i+1\n  }\n  \n  \n  xdata <- cdata[op$Index]\n  names(xdata) <- 'Value'\n  return(merge(xdata,'op'=as.factor(op$Series)))\n} #代码省略\n\ntdata<-Signal(cdata,pdata)\nhead(tdata)\n\n#6、模拟交易\n#利用交易信号数据，进行模拟交易\n#设定交易参数，以$10W为本金，满仓买入或卖出，手续为0，传入交易信号。\n#模拟交易\n#参数：交易信号tdata ,本金capital,持仓比例position,手续费比例fee\ntrade<-function(tdata,capital=100000,position=1,fee=0){\n  \n  value <- fortify(tdata$Value,melt=TRUE)$Value\n  # %/%  %%\n  asset <- capital\n  amount <- asset%/%value[1]\n  cash <- asset%%value[1]\n  #奇数为0，偶数为asset减去上一次的。S(2)-B(1)\n  diff <- 0.00\n  i<-2\n  nrow <- nrow(tdata)\n  while(i<=nrow){\n    #B 买入\n    if(tdata[i,]$op==1){\n      asset <- c(asset,tail(asset,1))\n      amount <- c(amount,tail(asset,1)%/%value[i])\n      cash <- c(cash,tail(asset,1)%%value[i])\n      diff <- c(diff,0.00)\n    }else if(tdata[i,]$op==2){\n      #S 卖出\n      cash <- c(cash,(tail(amount,1)*value[i])+tail(cash,1))\n      amount <- c(amount,0)\n      asset <- c(asset,tail(amount,1)*value[i]+tail(cash,1))\n      diff <- c(diff,tail(asset,1)-tail(asset,2)[1])\n    }\n    i=i+1\n  }\n  \n  result <- list()\n  result[['ticks']] <- merge(tdata,cash,amount,asset,diff)\n  \n  indexRise <- c()\n  indexFall <- c()\n  i <- 2\n  while(i<=nrow){\n    if(result[['ticks']][i,]$diff >= 0){\n      indexRise <- c(indexRise,i-1,i)\n    }else if(result[['ticks']][i,]$diff < 0){\n      indexFall <- c(indexFall,i-1,i)\n    }\n    i <- i+2\n  }\n  \n  result[['rise']] <- result$ticks[indexRise]\n  result[['fall']] <- result$ticks[indexFall]\n  return(result)\n  \n} #代码省略\nresult1<-trade(tdata,100000)\n\n# 查看每笔交易\nhead(result1$ticks)\n\n#7、计算收益率，并记录在一个列表里面，生成dataframe，信息包含\n#日期，代码，名称，收益率，涨跌幅，近1周涨跌，近1月涨跌，年初至今涨跌。\n\n\n#8、#CSI300指数 ：hs300<-getDailyQuote(data='mktDataIndex',qtid=c('000300.SH'),key=key)\n\n",
    "created" : 1453441351682.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "16588476",
    "id" : "8CF6A591",
    "lastKnownWriteTime" : 1453447383,
    "path" : "~/GitHub/Rcoder/qutke_code/20160120/MA.R",
    "project_path" : "qutke_code/20160120/MA.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}